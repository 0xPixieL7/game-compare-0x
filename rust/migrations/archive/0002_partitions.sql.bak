-- 0002_partitions.sql
-- Partition helper functions, trigger, and pre-create horizon

-- Ensure we operate within our schema
SET search_path TO public;

-- Function to ensure a monthly partition exists and essential indexes created
CREATE OR REPLACE FUNCTION ensure_price_partition(ts timestamptz)
RETURNS void LANGUAGE plpgsql AS $$
DECLARE
  start_ts timestamptz := date_trunc('month', ts);
  end_ts timestamptz := (start_ts + interval '1 month');
  part_name text := 'prices_' || to_char(start_ts, 'YYYY_MM');
BEGIN
  -- Create partition if missing
  EXECUTE format('CREATE TABLE IF NOT EXISTS %I PARTITION OF prices FOR VALUES FROM (%L) TO (%L)', part_name, start_ts, end_ts);

  -- Standard index (offer_jurisdiction_id, recorded_at)
  EXECUTE format('CREATE INDEX IF NOT EXISTS %I_oj_recorded_at ON %I (offer_jurisdiction_id, recorded_at)', part_name, part_name);
  -- Index on recorded_at alone (for pruning scans)
  EXECUTE format('CREATE INDEX IF NOT EXISTS %I_recorded_at ON %I (recorded_at)', part_name, part_name);

  -- (Removed dynamic partial 30d index; use standard indexes to avoid non-immutable predicate issues)
END;
$$;

-- Insert trigger to auto-provision partitions
CREATE OR REPLACE FUNCTION prices_partition_insert_trigger()
RETURNS TRIGGER LANGUAGE plpgsql AS $$
BEGIN
  PERFORM ensure_price_partition(NEW.recorded_at);
  RETURN NEW;
END; $$;

DROP TRIGGER IF EXISTS prices_partition ON prices;
CREATE TRIGGER prices_partition BEFORE INSERT ON prices FOR EACH ROW EXECUTE FUNCTION prices_partition_insert_trigger();

-- Pre-create horizon: last 12 months + next 6 months
DO $$
DECLARE
  start_month date := (date_trunc('month', now()) - interval '12 months')::date;
  end_month date := (date_trunc('month', now()) + interval '6 months')::date;
  cur date := start_month;
BEGIN
  WHILE cur < end_month LOOP
  PERFORM ensure_price_partition(cur);
    cur := (cur + interval '1 month')::date;
  END LOOP;
END $$;
